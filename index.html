<html>

<head>
    <title>aframe game of life</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>

        AFRAME.registerComponent('game-of-life', {

            schema: {
                interval: { type: 'number', default: 5000 }
            },

            init: function () {

                this.elapsedTime = 0;

                this.stepSeconds = 1;
                this.degreesPerSecond = 45;

                let start = undefined;  // TODO - get from attributes
                let aliveChance = 0.2;

                this.cols = { low: -4, high: 4 };
                this.rows = { low: -4, high: 4 };

                let x = this.cols.high - this.cols.low;
                let y = this.rows.high - this.rows.low;

                this.grid = start ? start : Array.from(Array(x), () => [...Array(y)].map(() => Math.random() < aliveChance ? 1 : 0));

                this.draw()
            },
            tick: function (time, timeDelta) {
                var rotation = this.el.getAttribute('rotation');
                rotation.y += this.degreesPerSecond * (timeDelta / 1000);
                this.el.setAttribute('rotation', rotation);

                this.elapsedTime += timeDelta;
                if (this.elapsedTime >= this.data.interval) {
                    this.step();
                    this.elapsedTime -= this.data.interval; // reset the timer
                }
            },
            draw: function () {
                var el = this.el;

                let z = 0;

                while (el.firstChild) {
                    // remove previous children
                    el.removeChild(el.firstChild);
                }           

                for (let c = this.cols.low, ix = 0; c < this.cols.high; c++, ix++) {
                    for (let r = this.rows.low, iy = 0; r < this.rows.high; r++, iy++) {
                        if (this.grid[ix][iy]) {
                            const obj = document.createElement("a-entity");
                            obj.setAttribute('mixin', 'tile');
                            obj.setAttribute("position", `${c} ${r} ${z}`);
                            obj.setAttribute('material', 'color', '#39ff14')
                            el.appendChild(obj);
                        }
                    }
                }
            },
            step: function () {
                for (let c = this.cols.low, ix = 0; c < this.cols.high; c++, ix++) {
                    for (let r = this.rows.low, iy = 0; r < this.rows.high; r++, iy++) {
                        this.grid[ix][iy] = !this.grid[ix][iy]
                    }
                }
                this.draw();
            }
        });

    </script>
</head>

<body>
    <a-scene>
        <a-assets>
            <a-mixin id="tile" geometry="primitive: box; width: 0.5; height: 0.5; depth: 0.5"></a-mixin>
            <a-mixin id="ball" geometry="primitive: sphere; radius: 0.2;"></a-mixin>
            <a-mixin id="fader"
                animation__fade="property: material.opacity; from:1; to:0; dur:2000; loop:false; easing:linear;"></a-mixin>
            <a-mixin id="shrinker"
                animation__shrinker="property: scale; from:1 1 1; to:0 0 0; dur:5000; loop:false; easing:linear;"></a-mixin>
        </a-assets>
        <a-entity id="rig" position="0 1.6 3">
            <a-entity id="camera" camera look-controls>
                <!-- <a-cursor></a-cursor> -->
            </a-entity>
        </a-entity>
        <a-entity id="game" position="0 1.6 -10" game-of-life></a-entity>
        <a-entity id="game" position="10 1.6 -10" game-of-life></a-entity>
        <a-entity id="game" position="-10 1.6 -10" game-of-life></a-entity>
        <a-sky color="#333333"></a-sky>
    </a-scene>

</body>

</html>